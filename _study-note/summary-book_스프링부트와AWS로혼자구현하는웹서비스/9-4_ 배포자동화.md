# 9-4. 배포 자동화


```shell script
#!/bin/bash

REPOSITORY=/home/ec2-user/app/step1
PROJECT_NAME=SpringBoot-Study
<<'END' 참고로 이거는 주석임
위의 레포지토리와 프로젝트명은 변수임
쉘에서는 타입없이 변수를 선언하고, =으로 대입할 수 있다.
그리고 '$변수명' 으로 변수를 사용할 수 있다. 
END

cd $REPOSITORY/$PROJECT_NAME

echo ">> Git Pull 받기"
git pull

echo ">> 프로젝트 Build 시작!"
./gradlew build   # 프로젝트 내부 gradlew로 build 수행

echo ">> step1 디렉토리로 이동"
cd $REPOSITORY

echo ">> Build 파일 복사"
cp $REPOSITORY/$PROJECT_NAME/build/libs/*.jar $REPOSITORY/  # build 결과물 = jar 파일을, jar 파일을 모아둔 위치로 복사

echo ">> 현재 구동 중인 애플리케이션 pid 확인"
CURRENT_PID=$(pgrep -f ${PROJECT_NAME}.*.jar)   # pgrep = process id만 추출하는 명령어(-f = 프로세스 이름으로 찾기)
### 책에서 이 부분이 아직 수정되지 않은 오타(4쇄)이니, 주의해서 위 코드대로 작성할 것! 

echo "현재 구동 중인 애플리케이션 pid : $CURRENT_PID"

if [ -z "$CURRENT_PID" ]; then    # process id 값을 보고 프로세스가 있으면 해당 프로세스 종료
    echo ">> 현재 구동 중인 애플리케이션이 없으므로 종료 X"
else 
    echo ">> kill -15 $CURRENT_PID"
    kill -15 $CURRENT_PID
    sleep 5
fi

echo ">> 새 애플리케이션 배포"
JAR_NAME=$(ls -tr $REPOSITORY/ | grep jar | tail -n 1)  # 새로 실행할 jar 파일명 찾음
# 여러 jar 파일이 생기기 때문에 tail -n으로 가장 나중(최신)의 jar 파일을 변수에 저장

echo ">> JAR 파일명 : $JAR_NAME"

nohup java -jar $REPOSITORY/$JAR_NAME 2>&1 &  
```