# 8-1. EC2에 프로젝트 배포 후 설정

## 1. 외부 Security 파일 등록

이전에 만들었던 배포 스크립트 실행 후, ```vim nohup.out```으로 파일을 열어 로그를 보면,  
맨 아래에 *'ClientRegistrationRepository 를 찾을 수 없다'* 는 에러가 발생한 것을 볼 수 있다.  

이 이유는, *ClientRegistrationRepository*를 생성하기 위해 필요한 **clientId, clientSecret**가 없어서다.  
그 정보는 **.gitignore**로 git 제외대상에 등록한```application-oauth.properties```파일에 있다.

근데 그렇다고 공개저장소에 ```application-oauth.properties```파일을 올릴 수는 없으니, **서버로 직접 이 파일을 복사**해주자.

```shell script
vim ~/app/application-oauth.properties
```
로 step1이 아닌 app 폴더에 properties 파일을 생성한다. (app 폴더에 올린 이유는 이후 step2, step3에서도 쓰기 위해서)  
그후, 로컬에 있는 ```application-oauth.properties``` 파일 내용을 복붙에 저장(```:wq```)한다.  

그리고 방금 생성한 ```application-oauth.properties```를 쓸 수 있게, ```deploy.sh```파일을 수정한다.
```shell script
nohup java -jar $REPOSITORY/$JAR_NAME 2>&1 &  # 이 부분을
```

```shell script
nohup java -jar \
    -Dspring.config.location=classpath:/application.properties,/home/ec2-user/app/application-oauth.properties \
    $REPOSITORY/$JAR_NAME 2>&1 &    # 이렇게 수정
```

> ### -Dspring.config.location
>
> 스프링 설정 파일 위치를 지정하는데,  
> 기본옵션이 담긴 ```application-oauth.properties```의 위치와 OAuth 설정이 담긴 ```application-oauth.properties```의 위치를 지정  
> - classpath가 붙으면 jar 안에 있는 resources 디렉토리를 기준으로 경로 생성  
> - ```application-oauth.properties```은 외부에 파일이 있기에 절대 경로를 사용


## 2. 스프링부트 프로젝트에 RDS 연동

RDS의 MariaDB를 스프링부트 프로젝트와 연동하기 위해서 아래 작업이 필요하다.
1. 테이블 생성 : (기존) H2에서 자동 생성 -> (MariaDB) 직접 쿼리 이용해 생성
2. 프로젝트 설정 : 자바 프로젝트가 MariaDB에 접근하기 위해 필요한 *데이터베이스 드라이버*를 프로젝트에 추가
3. EC2(리눅스 서버) 설정 : DB 접속 정보는 중요하게 보호해야 될 정보기에(해킹 위험) EC2 서버 내부에서 접속 정보를 관리하도록 설정

#### 1. RDS 테이블 생성

가장먼저 RDS에 2가지 종류의 테이블을 생성하자.

1. **JPA**가 사용될 엔티티 테이블

    **테스트 코드 수행시 로그로 생성되는 쿼리 사용**하면 됨  
    -> ```create table```로 시작하는 부분부터 복붙해서 RDS에 반영
    
2. **스프링 세션**이 사용될 테이블
    
    **schema-mysql.sql** 파일에서 스프링 세션 테이블 확인 가능  
    -> File 검색(ctrl+shift+n)으로 검색 -> 파일 안에 있는 세션 테이블 생성문을 복붙해서 RDS에 반영 

#### 2. 프로젝트 설정

이전까지 H2 드라이버만 있었으니, 이제 MariaDB 드라이버를 ```build.gradle```에 등록
```
compile("org.mariadb.jdbc:mariadb-java-client")
```
