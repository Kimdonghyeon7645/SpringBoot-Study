# Spring Web Application (스프링 웹 어플리케이션) 아키텍쳐

웹 어플리케이션을 만들때, 아무생각없이 코드를 나누지 않고, 하나로 짬뽕해놓으면 어떨까?  
서버를 식당으로 비유하자면, 역할에 따라 분리되지 않은 코드는 **식당에서 요리사가 모든 역할을 하는 꼴이다.**  

식당이 한산하다면 혼자서 모든 역할을 해도 되겠지만, 규모가 큰 식당이라면 어떨까?  
실제 식당에서도 서빙하는 사람, 요리하는 사람, 관리하는 사람이 분리되듯이,  
코드도 역할에 따라 분리할 필요가 있다.

이로써 코드의 **결합도(다른 모듈에 의존하는 정도)** 는 낮추고, **응집도(모듈 내부의 기능이 밀접하게 관련있는 정도)** 는 높일 수 있는 것이다.  
(결합도가 낮을 수록, 응집도는 높을 수록 -> 유지보수성과 가독성이 높아진다.)

## 3-티어 애플리케이션 아키텍쳐

![image](https://user-images.githubusercontent.com/48408417/99790334-4c7fc580-2b67-11eb-84c9-8a26c9d93373.png)
  
### - 웹 레이어(Web Layer, 프리젠테이션 계층)

- **컨트롤러(@Controller)** 와 JSP/타임리프 등의 **뷰 템플릿** 이 사용되는 영역
- 이것 말고도, 필터(@Filer), 인터셉터, 컨트롤러 어드바이스(@ControllerAdvice) 등 **외부 요청을 처리하고 응답을 반환하는 영역**

### - 서비스 레이어(Service Layer, 서비스 계층)

- 일반적으론 컨트롤러(Controller)와 데이터 엑세스 객체(DAO) 사이에서 사용되는 영역 (**@Service** 사용되는 영역)
- 로직을 하나의 트렌젝션<sup>[1](#트렌젝션)</sup>으로 처리하기 위해, **@Transactional**(트렌젝션 경계)을 선언하는 영역
- 도메인 모델에서 로직을 처리하고, 서비스는 **트렌젝션과 도메인 간 순서만 보장** 
- 서비스가 다른 서비스를 참조가능하나, 계층구조가 명확해야 함(순환참조 안 발생하려면)

### - 레포지토리 레이어(Repository Layer, 데이터 엑세스 계층)

- DB 같은 데이터 저장소에 접근하는 영역
- **DAO(Data Access Object)** 영역으로 이해하면 쉬움

---

### - DTO(data Transfer Object)

- 위의 3가지 **계층 간에 데이터 교환을 위한 객체 = DTO**, DTO 들의 영역 = **DTOs**   
- 뷰 템플릿에서 사용될 객체, 데이터 엑세스 계층에서 결과로 넘겨준 객체 등이 해당

### - 도메인 모델(Domain Model)

- 도메인<sup>[2](#도메인)</sup> 을 **모든 사람이 동일한 관점으로 이해, 공유 가능하도록 단순화(개념화) 시킨 것 = 도메인 모델**
- 도메인 모델은 3가지 종류의 객체로 구성
    - **엔티티(Entity)** : 영속성(=메모리영역 대신 DB에 저장, 애플리케이션 종료되도 데이터가 유지) 도메인 오브젝트  
        DB의 테이블과 연결되는 객체
    - **VO(Value Object, 값 객체)** : Entity와 비슷한 성격<sup>[3](#VO)</sup>
        - 연속성(=필요에 따라 속성이 변경 가능한지)에 따라, 불변하면 VO로 분류(->내부 프로퍼티를 final로 지정)
        - DB 테이블과 관계가 있을 필요 없음
    - **도메인 서비스(Domain Services)**<sup>[4](#도메인서비스)</sup> : 도메인 주도 개발(DDD)에서 서비스는 엔티티(Entity), 값 객체(Value Object)와 같은 계층에서 오브젝트로 취급되는 것  
        - 객체의 행위, 활동을 표현하는 단위로 사용
        - Aggregate<sup>[5](#Aggregate)</sup> 경계(=트렌젝션) 내의 객체 통제 권한은 Entity, VO 에서 처리 (이미 Entity, VO에서 충분히 다룰 수 있는 기능을 서비스로 제작하면 안됌)  
        - 서로 다른 Aggregate 경계를 가지는 도메인 끼리만 서비스 사용
        

## 비즈니스 처리, 트렌젝션 스크립트 패턴 vs 도메인 모델 패턴<sup>[6](#비즈니스처리패턴)</sup>

- ### 트렌젝션 스크립트(Transaction Script) 패턴 
    : 데이터와 프로세스를 서로 다른 모듈에서 다룸 (절차지향)
    - **하나의 트렌젝션으로 구성된 로직을 단일 함수, 스크립트에서 처리**
    - 모든 로직이 단일 스크립트(서비스 클래스 내부)에서 처리되기에, 서비스 계층이 필요없음 
        -> 서비스 계층은 여러 도메인간 로직의 순서를 보장하고, 하나의 트렌젝션으로 처리하는 계층인데, 이미 단일 스크립트에 담긴 로직자체가 하나의 트렌젝션이기에 
    - 도메인 모델 = 단순한 데이터 덩어리로 쓰임 
        -> 단일 스크립트에서 데이터를 어떻게 처리할 지에 관한 프로세스가 모두 있기에
    - 구현이 단순하고 쉽지만, 비즈니스 로직이 복잡해질 수록 가독성 떨어짐(난잡해짐)
- ### 도메인 모델(Domain Model) 패턴
    : 데이터와 프로세스를 객체란 단위에서 함께 다룸 (객체지향)
    - **도메인 모델에서 비즈니스 로직 처리, 서비스 계층에선 도메인간 순서 보장+하나의 트렌젝션으로 처리**
    - 객체지향 패러다임과 관계형 데이터베이스의 패러다임이 불일치 -> JPA로 해결
    - 구축하는데 많은 노력이 필요하지만, 객체 지향에 기반한 재사용성, 확장성과 유지보수,테스트 편리함이 장점
      
## Entity 클래스 vs DTO, View Layer와 DB Layer 역할 분리

- **Entity 클래스** : 데이터베이스와 맞닿은 핵심 클래스 (이 기준으로 테이블 생성, 스키마 변경)  
-> 화면 변경같은 사소한 기능 변경때문에 Entity 클래스 변경 = 너무 큰 변경
-> 더욱이 Request/Response 클래스로 Entity 클래스는 절대로 사용하지 않음!
- **DB 영역은 Entity 클래스로, View 영역은 DTO** 로 꼭 분리해서 사용 

## 각주

<li>    
<a name="트렌젝션">트렌젝션</a> 
: 더이상 쪼갤 수 없는 최소 단위의 작업,<br /> 
<a href="https://happyer16.tistory.com/entry/6-6-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-%EC%86%8D%EC%84%B1?category=692836">참고1</a>, 
<a href="https://goddaehee.tistory.com/167">참고2</a> 
</li>

<li>    
<a name="도메인">도메인</a> 
: 소프트웨어로 해결, 구현하고자 하는 문제영역<br />
    <ul>
    ex) 온라인 서점이 구현할 소프트웨어일때, (상품조회, 구매, 배송, 추적등의 기능을 구현할) 온라인 서점 = 도메인, 한 도메인(온라인 서점)은 여러 하위 도메인으로 나뉠 수 있음<br />
    자세한 내용은 DDD, 도메인 공학 참고<br />
    </ul>
<a href="https://medium.com/react-native-seoul/%EB%8F%84%EB%A9%94%EC%9D%B8-%EC%A3%BC%EB%8F%84-%EC%84%A4%EA%B3%84-domain-driven-design-in-real-project-1-%EB%8F%84%EB%A9%94%EC%9D%B8-83a5e31c5e45">참고1</a>, 
<a href="https://12bme.tistory.com/522">참고2</a> 
</li>

<li>    
<a name="VO">VO와 엔티티(Entity)를 분류하는 방법</a> 
: <a href="http://springmvc.egloos.com/624397">참고</a> 
</li>

<li>    
<a name="도메인서비스">도메인 서비스</a> 
: <a href="http://springmvc.egloos.com/726522">참고</a> 
</li>
  
<li>    
<a name="Aggregate">Aggregate</a> 
: <a href="http://blog.naver.com/PostView.nhn?blogId=loopbit&logNo=221201046142&parentCategoryNo=49&categoryNo=56&viewDate=&isShowPopularPosts=false&from=postView">참고</a> 
</li>

<li>    
<a name="비즈니스처리패턴">비즈니스 로직에 대해서, 트렌젝션 스크립트 방식을 쓰지 않는다고 합니다</a>
: 왜 그런지 못참겠어서 알아보다가, 읽던 책을 쓴 저자가 정리한 글을 찾게 되어서 정리합니다.   
<a href="https://jojoldu.tistory.com/346">해당 링크</a>, <a href="https://javacan.tistory.com/entry/94">그외 참고</a>
</li>
